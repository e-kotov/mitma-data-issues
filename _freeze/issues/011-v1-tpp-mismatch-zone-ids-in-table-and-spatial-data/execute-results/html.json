{
  "hash": "6a9e03959ea4fc2e508a94f4f04ab889",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Mismatch of zone ids in spatial data and trips per person table for municipal zoning\"\nfrom: markdown+emoji\ncode-annotations: hover\ndate: \"2024-08-17\"\ndate-modified: \"2024-08-17\"\ncategories:\n    - tabular data\n    - incorrect data\n    - zone IDs mismatch\n    - \"importance: high\"\nissue-importance: \"3 - high\"\nstatus: \"⚠️ active\"\n---\n\n\n\n---\n\n**Status**: {{< meta status >}}\n\n**Importance**: {{< meta issue-importance >}}\n\n**Summary**: The zone IDs in the municipal trips per person data (`maestra2-mitma-municipios`) are not consistent with the zone IDs in the municipal boundaries data (`zonificacion-municipios/municipios_mitma.shp`). TODO: list mismatching ids?\n\n**Expected Results**: The zone IDs in the municipal trips per person data (`maestra2-mitma-municipios`) should be consistent with the zone IDs in the municipal boundaries data (`zonificacion-municipios/municipios_mitma.shp`).\n\n---\n\n\n---\n\n\n### Steps to Reproduce\n\n1. **Load Data**\n\nLoad libraries and define data files.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(here)\nlibrary(DT)\n\n\ntrips_per_person_file_2020_03_14 <- here(\"data/raw_data_cache/v1/maestra2-mitma-municipios/ficheros-diarios/year=2020/month=3/day=14/maestra_2_mitma_municipio.txt.gz\")\ntrips_per_person_file_2020_10_01 <- here(\"data/raw_data_cache/v1/maestra2-mitma-municipios/ficheros-diarios/year=2020/month=10/day=1/maestra_2_mitma_municipio.txt.gz\")\nmunicipal_boundaries_data_file <- here(\"data/raw_data_cache/v1/zonificacion-municipios/municipios_mitma.shp\")\ndistrict_boundaries_data_file <- here(\"data/raw_data_cache/v1/zonificacion-distritos/distritos_mitma.shp\")\n```\n:::\n\n\n\nLoad the data.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrips_per_person_2020_03_14 <- readr::read_delim(trips_per_person_file_2020_03_14, delim = \"|\", show_col_types = FALSE, name_repair = \"unique_quiet\")\ntrips_per_person_2020_10_01 <- readr::read_delim(trips_per_person_file_2020_10_01, delim = \"|\", show_col_types = FALSE, name_repair = \"unique_quiet\")\nmunicipal_boundaries <- read_sf(municipal_boundaries_data_file)\ndistrict_boundaries <- read_sf(district_boundaries_data_file)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(trips_per_person_2020_03_14)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 8,744\nColumns: 4\n$ fecha         <dbl> 20200314, 20200314, 20200314, 20200314, 20200314, 202003…\n$ distrito      <chr> \"01001_AM\", \"01001_AM\", \"01001_AM\", \"01001_AM\", \"01002\",…\n$ numero_viajes <chr> \"0\", \"1\", \"2\", \"2+\", \"0\", \"1\", \"2\", \"2+\", \"0\", \"1\", \"2\",…\n$ personas      <dbl> 5498.025, 320.152, 1472.050, 1796.115, 5392.325, 728.374…\n```\n\n\n:::\n\n```{.r .cell-code}\nglimpse(trips_per_person_2020_10_01)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 8,764\nColumns: 4\n$ fecha         <dbl> 20201001, 20201001, 20201001, 20201001, 20201001, 202010…\n$ distrito      <chr> \"01001_AM\", \"01001_AM\", \"01001_AM\", \"01001_AM\", \"01002\",…\n$ numero_viajes <chr> \"0\", \"1\", \"2\", \"2+\", \"0\", \"1\", \"2\", \"2+\", \"0\", \"1\", \"2\",…\n$ personas      <dbl> 2614.317, 245.434, 2280.543, 3836.331, 3956.197, 497.415…\n```\n\n\n:::\n\n```{.r .cell-code}\nglimpse(municipal_boundaries)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 2,205\nColumns: 2\n$ ID       <chr> \"16078\", \"07058_AM\", \"36057\", \"38033_AM\", \"06109_AM\", \"32007_…\n$ geometry <MULTIPOLYGON [m]> MULTIPOLYGON (((583277.4 44..., MULTIPOLYGON (((…\n```\n\n\n:::\n\n```{.r .cell-code}\nglimpse(district_boundaries)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 2,850\nColumns: 2\n$ ID       <chr> \"2408910\", \"22117_AM\", \"2305009\", \"07058_AM\", \"2305006\", \"230…\n$ geometry <MULTIPOLYGON [m]> MULTIPOLYGON (((290940.1 47..., MULTIPOLYGON (((…\n```\n\n\n:::\n:::\n\n\n\n\n### Results\n\n2. **Not all zone IDs in the municipal level trips per person dataset can be found in the municipal boundaries dataset.**\n\nNot all zone (`distrito`) IDs in the municipal level trips per person dataset can be found in the municipal boundaries dataset. For example, on `2020-03-14`, all IDs do mathc, but on `2020-10-01`, 5 IDs mismatch.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(!unique(trips_per_person_2020_03_14$distrito) %in% unique(municipal_boundaries$ID))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n\n```{.r .cell-code}\nsum(!unique(trips_per_person_2020_10_01$distrito) %in% unique(municipal_boundaries$ID))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5\n```\n\n\n:::\n:::\n\n\n\nHere are the mismatching IDs:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunique(trips_per_person_2020_10_01$distrito)[\n  !unique(trips_per_person_2020_10_01$distrito) %in% unique(municipal_boundaries$ID)\n]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"04902\" \"28006\" \"28106\" \"28123\" \"28127\"\n```\n\n\n:::\n:::\n\n\n\nIn the spatial dataset we do not have the IDs above, however we do have similar IDs with extra digits:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmunicipal_boundaries |> filter(ID %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) # these IDs exist\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 5 features and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 419573.3 ymin: 4059438 xmax: 530623 ymax: 4493337\nProjected CRS: ETRS89 / UTM zone 30N (N-E)\n# A tibble: 5 × 2\n  ID                                                                    geometry\n* <chr>                                                       <MULTIPOLYGON [m]>\n1 2812301 (((455833.8 4471420, 455908.9 4472066, 456023.8 4472526, 455932.7 447…\n2 0490201 (((510312.5 4064495, 509896.8 4064947, 509553.9 4065352, 509030.9 406…\n3 2810601 (((437139.6 4452138, 437133.4 4451989, 437585.1 4451440, 437385.4 445…\n4 2812701 (((428935.1 4480873, 428572.2 4481050, 428255.8 4481124, 427733.7 448…\n5 2800601 (((446243 4484315, 445604.6 4484363, 445359.4 4484328, 445102.9 44846…\n```\n\n\n:::\n\n```{.r .cell-code}\nmunicipal_boundaries |> filter(ID %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) # these do not\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 0 features and 1 field\nBounding box:  xmin: NA ymin: NA xmax: NA ymax: NA\nProjected CRS: ETRS89 / UTM zone 30N (N-E)\n# A tibble: 0 × 2\n# ℹ 2 variables: ID <chr>, geometry <GEOMETRY [m]>\n```\n\n\n:::\n:::\n\n\n\n\nIt seems like at some point in time in this dataset, the IDs have changed, as we cannot find the same IDs in the data for different dates, as seen below:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrips_per_person_2020_03_14 |> filter(distrito %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 20\n```\n\n\n:::\n\n```{.r .cell-code}\ntrips_per_person_2020_03_14 |> filter(distrito %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntrips_per_person_2020_10_01 |> filter(distrito %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n\n```{.r .cell-code}\ntrips_per_person_2020_10_01 |> filter(distrito %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 20\n```\n\n\n:::\n:::\n\n\n\n\nThe longer IDs are not expected to be in the spatial data for municipalities, but they are there, as seen below:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmunicipal_boundaries |> filter(ID %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) |> nrow() # these IDs exist\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5\n```\n\n\n:::\n\n```{.r .cell-code}\nmunicipal_boundaries |> filter(ID %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) |> nrow() # these do not\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n\nWhat makes the matters more complicated, is that these longer IDs also can be found in the district boundaries, as seen below:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndistrict_boundaries |> filter(ID %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) |> nrow() # these IDs exist\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5\n```\n\n\n:::\n\n```{.r .cell-code}\ndistrict_boundaries |> filter(ID %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) |> nrow() # these do not\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n\nThrefore it is unclear with which spatial data the trip counts in the trips per person data for municipalities is actually associated.\n\nLet's filter the spatial data for both districts and municipalities to only include these IDs and compare them visually.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmunicipal_boundaries_subset <- municipal_boundaries |> filter(ID %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\"))\ndistrict_boundaries_subset <- district_boundaries |> filter(ID %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot()+\n  geom_sf(data = municipal_boundaries_subset, fill = \"grey50\", col = NA) +\n  geom_sf(data = district_boundaries_subset, fill = NA, col = \"blue\")\n```\n\n::: {.cell-output-display}\n![](011-v1-tpp-mismatch-zone-ids-in-table-and-spatial-data_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\nThese seem to match perfectly, therefore they can probably be assumed to be the same.\n\n### Is there such an issue with the district level data?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrips_per_person_2020_03_14_distr <- readr::read_delim(\n  here(\"data/raw_data_cache/v1/maestra2-mitma-distritos/ficheros-diarios/year=2020/month=3/day=14/maestra_2_mitma_distrito.txt.gz\"),\n  delim = \"|\", show_col_types = FALSE, name_repair = \"unique_quiet\")\ntrips_per_person_2020_10_01_distr <- readr::read_delim(\n  here(\"data/raw_data_cache/v1/maestra2-mitma-distritos/ficheros-diarios/year=2020/month=10/day=1/maestra_2_mitma_distrito.txt.gz\"),\n  delim = \"|\", show_col_types = FALSE, name_repair = \"unique_quiet\")\n\n\ntrips_per_person_2020_03_14_distr |> filter(distrito %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 20\n```\n\n\n:::\n\n```{.r .cell-code}\ntrips_per_person_2020_03_14_distr |> filter(distrito %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n\n```{.r .cell-code}\ntrips_per_person_2020_10_01_distr |> filter(distrito %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 20\n```\n\n\n:::\n\n```{.r .cell-code}\ntrips_per_person_2020_10_01_distr |> filter(distrito %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n\nNo such issue, the data for districts seem to be consistent.\n\n### Is there such an issue with the origin-destination data?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nod_municip_2020_03_14 <- readr::read_delim(\n  here(\"data/raw_data_cache/v1/maestra1-mitma-municipios/ficheros-diarios/year=2020/month=3/day=14/maestra_1_mitma_municipio.txt.gz\"),\n  delim = \"|\", show_col_types = FALSE, name_repair = \"unique_quiet\")\n\n\nod_municip_2020_10_01 <- readr::read_delim(\n  here(\"data/raw_data_cache/v1/maestra1-mitma-municipios/ficheros-diarios/year=2020/month=10/day=1/maestra_1_mitma_municipio.txt.gz\"),\n  delim = \"|\", show_col_types = FALSE, name_repair = \"unique_quiet\")\n\n\nod_municip_2020_03_14 |> filter(origen %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5900\n```\n\n\n:::\n\n```{.r .cell-code}\nod_municip_2020_03_14 |> filter(origen %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n\n```{.r .cell-code}\nod_municip_2020_03_14 |> filter(destino %in% c(\"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5874\n```\n\n\n:::\n\n```{.r .cell-code}\nod_municip_2020_03_14 |> filter(destino %in% c(\"04902\", \"28006\", \"28106\", \"28123\", \"28127\")) |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n\nThe data for origin-destination seem to be consistent.\n\n### Conclusion and how the issue should be fixed\n\nThe zone IDs in the tables for municipal level trips per person data and spatial data do not match starting with a certain date. The zones with IDs \"0490201\", \"2800601\", \"2810601\", \"2812301\", \"2812701\" should be recoded to \"04902\", \"28006\", \"28106\", \"28123\", \"28127\" during the import process of the trips per person tables. This can be easily done using the existing approach of SQL-based view creation in the [`{spanishoddata}`](https://github.com/Robinlovelace/spanishoddata){target='_blank'} R package.\n\n### Links to the original files\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfiles <- spanishoddata:::spod_available_data(1, data_dir = here(\"data\"))\n\n# Filter relevant files\nrelevant_files <- files |> \n  filter((local_path %in% c(\n    trips_per_person_file_2020_03_14,\n    trips_per_person_file_2020_10_01)) |\n    grepl(\"zonificacion\", local_path)\n  )\n\n# Create HTML links\nrelevant_files <- relevant_files |> \n  mutate(target_url = paste0(\"<a href='\", target_url, \"' target='_blank'>\", target_url, \"</a>\"))\n\n# Render the DT table with links\ndatatable(relevant_files, escape = FALSE, options = list(pageLength = 5))\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-7b1b5da5860b15c77ffd\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-7b1b5da5860b15c77ffd\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\"],[\"<a href='https://opendata-movilidad.mitma.es/zonificacion_municipios.zip' target='_blank'>https://opendata-movilidad.mitma.es/zonificacion_municipios.zip<\\/a>\",\"<a href='https://opendata-movilidad.mitma.es/zonificacion_distritos.zip' target='_blank'>https://opendata-movilidad.mitma.es/zonificacion_distritos.zip<\\/a>\",\"<a href='https://opendata-movilidad.mitma.es/maestra2-mitma-municipios/ficheros-diarios/2020-03/20200314_maestra_2_mitma_municipio.txt.gz' target='_blank'>https://opendata-movilidad.mitma.es/maestra2-mitma-municipios/ficheros-diarios/2020-03/20200314_maestra_2_mitma_municipio.txt.gz<\\/a>\",\"<a href='https://opendata-movilidad.mitma.es/maestra2-mitma-municipios/ficheros-diarios/2020-10/20201001_maestra_2_mitma_municipio.txt.gz' target='_blank'>https://opendata-movilidad.mitma.es/maestra2-mitma-municipios/ficheros-diarios/2020-10/20201001_maestra_2_mitma_municipio.txt.gz<\\/a>\"],[\"2020-12-29T00:14:07Z\",\"2020-12-29T00:13:44Z\",\"2020-12-28T22:50:10Z\",\"2020-12-28T22:50:09Z\"],[\"zip\",\"zip\",\"gz\",\"gz\"],[null,null,\"2020-03-01\",\"2020-10-01\"],[null,null,\"2020-03-14\",\"2020-10-01\"],[\"/Users/ek/home/online_sync/nextcloud/_github/mitma-data-issues/data/raw_data_cache/v1/zonificacion_municipios.zip\",\"/Users/ek/home/online_sync/nextcloud/_github/mitma-data-issues/data/raw_data_cache/v1/zonificacion_distritos.zip\",\"/Users/ek/home/online_sync/nextcloud/_github/mitma-data-issues/data/raw_data_cache/v1/maestra2-mitma-municipios/ficheros-diarios/year=2020/month=3/day=14/maestra_2_mitma_municipio.txt.gz\",\"/Users/ek/home/online_sync/nextcloud/_github/mitma-data-issues/data/raw_data_cache/v1/maestra2-mitma-municipios/ficheros-diarios/year=2020/month=10/day=1/maestra_2_mitma_municipio.txt.gz\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>target_url<\\/th>\\n      <th>pub_ts<\\/th>\\n      <th>file_extension<\\/th>\\n      <th>data_ym<\\/th>\\n      <th>data_ymd<\\/th>\\n      <th>local_path<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"pageLength\":5,\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"target_url\",\"targets\":1},{\"name\":\"pub_ts\",\"targets\":2},{\"name\":\"file_extension\",\"targets\":3},{\"name\":\"data_ym\",\"targets\":4},{\"name\":\"data_ymd\",\"targets\":5},{\"name\":\"local_path\",\"targets\":6}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false,\"lengthMenu\":[5,10,25,50,100]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n",
    "supporting": [
      "011-v1-tpp-mismatch-zone-ids-in-table-and-spatial-data_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}