{
  "hash": "bc0662077a759ace3548846d87b392dc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"District zone IDs in municipal overnight stays data\"\nfrom: markdown+emoji\ncode-annotations: hover\ndate: \"2024-07-16\"\ndate-modified: \"2024-08-17\"\ncategories:\n    - tabular data\n    - incorrect data\n    - zone IDs mismatch\n    - \"importance: medium\"\nissue-importance: \"2 - medium\"\nstatus: \"⚠️ active\"\n---\n\n\n\n\n---\n\n**Status**: {{< meta status >}}\n\n**Importance**: {{< meta issue-importance >}}\n\n**Note**: According to the [official methodology](https://www.transportes.gob.es/recursos_mfom/paginabasica/recursos/a3_informe_metodologico_resumen_v6.pdf) this is by design. However, still needs to be addressed in workflows within the [`{spanishoddata}`](https://github.com/Robinlovelace/spanishoddata){target='_blank'} R package.\n\n**Summary**: The zone IDs in the municipal overnight stays data are not consistent with the zone IDs in the municipal boundaries data. The zone IDs in the municipal overnight stays data for the residential location column `zona_residencia` are a combination of district and municipal IDs.\n\n**Expected Results**: The zone IDs in the municipal overnight stays data should be consistent with the zone IDs in the municipal boundaries data (unless the use of district IDs in the residential location column `zona_residencia` is intentional).\n\n---\n\n\n---\n\n\n### Steps to Reproduce\n\n1. **Load Data**\n\nLoad libraries and define data files.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(here)\nlibrary(DT)\n\n\novernight_stays_file <- here(\"data/raw_data/v2/estudios_basicos/por-municipios/pernoctaciones/ficheros-diarios/2022-01/20220101_Pernoctaciones_municipios.csv.gz\")\nmunicipal_boundaries_data_file <- here(\"data/raw_data/v2/zonificacion/zonificacion_municipios/zonificacion_municipios.shp\")\ndistrict_boundaries_data_file <- here(\"data/raw_data/v2/zonificacion/zonificacion_distritos/zonificacion_distritos.shp\")\n```\n:::\n\n\n\n\nLoad the data.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\novernight_stays <- readr::read_delim(overnight_stays_file, delim = \"|\", show_col_types = FALSE, name_repair = \"unique_quiet\")\n# municipal_boundaries <- read_sf(municipal_boundaries_data_file) |> filter(!grepl(\"PT|FR|externo\", ID))\n# district_boundaries <- read_sf(district_boundaries_data_file) |> filter(!grepl(\"PT|FR|externo\", ID))\nmunicipal_boundaries <- read_sf(municipal_boundaries_data_file)\ndistrict_boundaries <- read_sf(district_boundaries_data_file)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(overnight_stays)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 515,748\nColumns: 4\n$ fecha             <dbl> 20220101, 20220101, 20220101, 20220101, 20220101, 20…\n$ zona_residencia   <chr> \"01001\", \"01001\", \"01001\", \"01001\", \"01001\", \"01001\"…\n$ zona_pernoctacion <chr> \"01001\", \"01017_AM\", \"01047_AM\", \"01051\", \"01059\", \"…\n$ personas          <dbl> 2447.613, 9.000, 2.514, 5.780, 181.970, 3.266, 3.266…\n```\n\n\n:::\n\n```{.r .cell-code}\nglimpse(municipal_boundaries)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 2,735\nColumns: 2\n$ ID       <chr> \"01001\", \"01002\", \"01004_AM\", \"01009_AM\", \"01010\", \"01017_AM\"…\n$ geometry <MULTIPOLYGON [m]> MULTIPOLYGON (((537856.7 47..., MULTIPOLYGON (((…\n```\n\n\n:::\n\n```{.r .cell-code}\nglimpse(district_boundaries)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 3,909\nColumns: 2\n$ ID       <chr> \"01001\", \"01002\", \"01004_AM\", \"01009_AM\", \"01010\", \"01017_AM\"…\n$ geometry <MULTIPOLYGON [m]> MULTIPOLYGON (((538090.2 47..., MULTIPOLYGON (((…\n```\n\n\n:::\n:::\n\n\n\n\n\n### Results\n\n2. **Not all residence location IDs in the municipal level overnight stays dataset can be found in the municipal boundaries dataset.**\n\nNot all residence location (`zona_residencia`) IDs in the municipal level overnight stays dataset can be found in the municipal boundaries dataset. Residence locations in municipal level overnight stays uses district IDs in addition to municipal IDs. That is, just using the municipal boundaries dataset is not enough to match all the residence locations in the overnight stays dataset.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(!unique(overnight_stays$zona_residencia) %in% unique(municipal_boundaries$ID))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1596\n```\n\n\n:::\n:::\n\n\n\n\nMeanwhile, all residence location (`zona_residencia`) IDs in the municipal level overnight stays can be found in the district boundaries dataset.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(!unique(overnight_stays$zona_residencia) %in% unique(district_boundaries$ID))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n\n\nOnly municipal IDs are used in the `zona_pernoctacion` column of the overnight stays dataset.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(!unique(overnight_stays$zona_pernoctacion) %in% unique(municipal_boundaries$ID))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0\n```\n\n\n:::\n:::\n\n\n\n\n\n3. **Sample of rows with residence location IDs coming from district breakdown in the municipal boundaries overnight stays**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nDT::datatable(overnight_stays |> filter(!zona_residencia %in% unique(municipal_boundaries$ID)) |> sample_n(100))\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-f80ca1563773cd052f79\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-f80ca1563773cd052f79\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\"67\",\"68\",\"69\",\"70\",\"71\",\"72\",\"73\",\"74\",\"75\",\"76\",\"77\",\"78\",\"79\",\"80\",\"81\",\"82\",\"83\",\"84\",\"85\",\"86\",\"87\",\"88\",\"89\",\"90\",\"91\",\"92\",\"93\",\"94\",\"95\",\"96\",\"97\",\"98\",\"99\",\"100\"],[20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101,20220101],[\"0812101\",\"0200304\",\"0905909\",\"0704802\",\"2804902\",\"3304414_AD\",\"2106401\",\"2807403\",\"3003005\",\"1802202\",\"4625019\",\"3002401\",\"0704004\",\"3302409\",\"1503001\",\"4109108\",\"4019406\",\"2806503\",\"1802303\",\"0304702\",\"1400201\",\"4607002\",\"4603103\",\"1709501\",\"0407902\",\"0307101\",\"2808001\",\"0808901\",\"2814802\",\"1103105\",\"2906708\",\"4801303\",\"1204006\",\"0501904\",\"2807904\",\"2906702\",\"2800502\",\"4802003\",\"0801901\",\"4625014\",\"2702805\",\"0801904\",\"0810103\",\"2807910\",\"3003006\",\"2806501\",\"2807903\",\"2807903\",\"0302102\",\"0200301\",\"0830701\",\"2807401\",\"1802202\",\"2804302\",\"4625006\",\"1808707\",\"4109103\",\"0803503\",\"0306507\",\"2105003\",\"1814002\",\"3120106\",\"0807304\",\"2807907\",\"3120106\",\"3501602\",\"1102704\",\"2411502\",\"0827905\",\"3412003\",\"0306304\",\"1711403\",\"0801901\",\"2006907\",\"1303403\",\"2807908\",\"0830502\",\"4314809\",\"2800501\",\"2807901\",\"3302407\",\"0608303\",\"4623502\",\"4508102\",\"0703601\",\"4105802\",\"3107702\",\"2811302\",\"1503008\",\"3907503\",\"2902503\",\"4718610\",\"0801909\",\"2006901\",\"1204005\",\"0801902\",\"0306301\",\"0827901\",\"5200108\",\"2807908\"],[\"01059\",\"16027_AM\",\"19024\",\"36055\",\"28040\",\"30030\",\"24092_AM\",\"48011\",\"12140_AM\",\"18137_AM\",\"46217_AM\",\"23074_AM\",\"14073\",\"27028\",\"35003_AM\",\"24039_AM\",\"13061\",\"13079\",\"48910_AM\",\"27028\",\"46021\",\"46120_AM\",\"17167_AM\",\"18063_AM\",\"49003_AM\",\"03097_AM\",\"45201\",\"06125_AM\",\"19046\",\"18022\",\"30003\",\"10067\",\"12138\",\"09018\",\"08263\",\"18157_AM\",\"46205\",\"03031\",\"46067_AM\",\"09390_AM\",\"27042_AM\",\"07065\",\"08106\",\"45021\",\"30001\",\"45082_AM\",\"15030\",\"16023_AM\",\"41091\",\"43148\",\"08056\",\"32063_AM\",\"18050_AM\",\"28014\",\"11022\",\"37107\",\"23080_AM\",\"08101\",\"30005\",\"29067\",\"18149_AM\",\"20071\",\"17094\",\"46250\",\"10104\",\"15035\",\"41038\",\"49021\",\"49151_AM\",\"11028\",\"28054\",\"17180_AM\",\"25204_AM\",\"03089\",\"13066\",\"50182\",\"22059_AM\",\"44246_AM\",\"23038\",\"04013\",\"43131\",\"21050\",\"46008\",\"15022_AM\",\"07044\",\"41058\",\"31077\",\"18140\",\"15901_AM\",\"33044\",\"29008\",\"49178_AM\",\"08123\",\"09219\",\"46250\",\"36026\",\"46111\",\"43050\",\"13092_AM\",\"47114\"],[2.72,2.901,11.56,3.926,4.723,2.327,3.82,2.093,2.007,16.459,3.467,5.62,3.596,2.921,10.74,4.203,5.23,9.297000000000001,2.164,3.758,10.094,11.199,2.169,11.326,7.582,2.763,6.229,2.599,18.15,4.225,1.858,4.513,32.626,13.499,2.965,5.078,3.569,9.577999999999999,4.285,2.181,182.727,4.877,9.547000000000001,3.352,12.449,5.293,121.566,7.071,3,2.012,14.502,2.129,3.651,9.337,5.252,5.84,20.544,9.621,1.976,3.007,14.347,9.077,3.356,512.549,4.255,5.03,38.219,10.263,1.658,1.629,9.407,4.744,2.518,2.593,19.15,4.418,2.277,21.948,3.633,179.926,8.757,5.435,8.401,2.714,7.904,7945.373,3361.732,2.439,11.038,24.035,14.566,42.167,29.124,8.194000000000001,202.503,11.1,2.61,14.633,8.648999999999999,24.656]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>fecha<\\/th>\\n      <th>zona_residencia<\\/th>\\n      <th>zona_pernoctacion<\\/th>\\n      <th>personas<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[1,4]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"fecha\",\"targets\":1},{\"name\":\"zona_residencia\",\"targets\":2},{\"name\":\"zona_pernoctacion\",\"targets\":3},{\"name\":\"personas\",\"targets\":4}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n\n\n### Links to the original files\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(here(\"R/901-download-helpers.R\"))\nfiles <- load_latest_v2_xml()\n\n# Filter relevant files\nrelevant_files <- files |> \n  filter(basename(local_path) %in% basename(c(\n    overnight_stays_file,\n    municipal_boundaries_data_file,\n    district_boundaries_data_file\n  )) )\n\n# Create HTML links\nrelevant_files <- relevant_files |> \n  mutate(target_url = paste0(\"<a href='\", target_url, \"' target='_blank'>\", target_url, \"</a>\"))\n\n# Render the DT table with links\ndatatable(relevant_files, escape = FALSE, options = list(pageLength = 5))\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-cea3e5f69dd914e164f7\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-cea3e5f69dd914e164f7\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\"],[\"<a href='https://movilidad-opendata.mitma.es/zonificacion/zonificacion_distritos/zonificacion_distritos.shp' target='_blank'>https://movilidad-opendata.mitma.es/zonificacion/zonificacion_distritos/zonificacion_distritos.shp<\\/a>\",\"<a href='https://movilidad-opendata.mitma.es/zonificacion/zonificacion_municipios/zonificacion_municipios.shp' target='_blank'>https://movilidad-opendata.mitma.es/zonificacion/zonificacion_municipios/zonificacion_municipios.shp<\\/a>\",\"<a href='https://movilidad-opendata.mitma.es/estudios_basicos/por-municipios/pernoctaciones/ficheros-diarios/2022-01/20220101_Pernoctaciones_municipios.csv.gz' target='_blank'>https://movilidad-opendata.mitma.es/estudios_basicos/por-municipios/pernoctaciones/ficheros-diarios/2022-01/20220101_Pernoctaciones_municipios.csv.gz<\\/a>\"],[\"2023-04-19T09:57:02Z\",\"2023-04-19T09:57:10Z\",\"2023-06-29T14:46:52Z\"],[\"shp\",\"shp\",\"gz\"],[null,null,\"2022-01-01\"],[null,null,\"2022-01-01\"],[\"data/raw_data/v2/zonificacion/zonificacion_distritos/zonificacion_distritos.shp\",\"data/raw_data/v2/zonificacion/zonificacion_municipios/zonificacion_municipios.shp\",\"data/raw_data/v2/estudios_basicos/por-municipios/pernoctaciones/ficheros-diarios/2022-01/20220101_Pernoctaciones_municipios.csv.gz\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>target_url<\\/th>\\n      <th>pub_ts<\\/th>\\n      <th>file_extension<\\/th>\\n      <th>data_ym<\\/th>\\n      <th>data_ymd<\\/th>\\n      <th>local_path<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"pageLength\":5,\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"target_url\",\"targets\":1},{\"name\":\"pub_ts\",\"targets\":2},{\"name\":\"file_extension\",\"targets\":3},{\"name\":\"data_ym\",\"targets\":4},{\"name\":\"data_ymd\",\"targets\":5},{\"name\":\"local_path\",\"targets\":6}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false,\"lengthMenu\":[5,10,25,50,100]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n",
    "supporting": [
      "010-incorrect-zone-ids-in-municipal-overnight-stays_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}